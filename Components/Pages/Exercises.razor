@page "/exercises"
@attribute [Authorize]
@rendermode InteractiveServer

@using GymTracker.Data
@using GymTracker.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider AuthStateProvider

<h1>Exercise library</h1>

@if (isAdmin)
{
    <section class="card">
        <h3>Create GLOBAL exercise (admin)</h3>

        <input placeholder="Exercise name" @bind="globalName"/>
        <textarea placeholder="Description" @bind="globalDescription"></textarea>

        <br /><br />
        <button class="add-btn" @onclick="CreateGlobalExercise">Create global</button>
    </section>
}

<section class="card">
    <h3>Create personal exercise</h3>

    <input placeholder="Exercise name" @bind="personalName"/>
    <textarea placeholder="Description" @bind="personalDescription"></textarea>

    <br /><br />
    <button class="add-btn" @onclick="CreatePersonalExercise">Create personal</button>

    @if (!string.IsNullOrEmpty(message))
    {
        <p style="color:lightgreen">@message</p>
    }
</section>

<h3>Global exercises</h3>

@if (!globalExercises.Any())
{
    <p>No global exercises</p>
}
else
{
    <ul>
        @foreach (var ex in globalExercises)
        {
            <li>
                <b>@ex.Name</b>

                @if (isAdmin)
                {
                    <button class="undo-btn" @onclick="() => DeleteGlobal(ex.Id)">Delete</button>
                }
            </li>
        }
    </ul>
}

<h3>My exercises</h3>

@if (!myExercises.Any())
{
    <p>No personal exercises</p>
}
else
{
    <ul>
        @foreach (var ex in myExercises)
        {
            <li>
                <b>@ex.Name</b>
                <button class="undo-btn" @onclick="() => DeletePersonal(ex.Id)">Delete</button>
            </li>
        }
    </ul>
}

@code {
    List<Exercise> globalExercises = new();
    List<Exercise> myExercises = new();

    string globalName = "";
    string globalDescription = "";

    string personalName = "";
    string personalDescription = "";

    string message = "";

    ApplicationUser? user;
    bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        user = await userManager.GetUserAsync(auth.User);

        isAdmin = await userManager.IsInRoleAsync(user!, "Admin");

        await LoadExercises();
    }

    async Task LoadExercises()
    {
        globalExercises = await db.Exercises
            .Where(e => e.IsGlobal)
            .OrderBy(e => e.Name)
            .ToListAsync();

        myExercises = await db.Exercises
            .Where(e => !e.IsGlobal && e.OwnerId == user!.Id)
            .OrderBy(e => e.Name)
            .ToListAsync();
    }

    async Task CreateGlobalExercise()
    {
        if (!isAdmin) return;

        if (string.IsNullOrWhiteSpace(globalName))
        {
            message = "Name required";
            return;
        }

        var exists = await db.Exercises.AnyAsync(e => e.Name.ToLower() == globalName.ToLower());
        if (exists)
        {
            message = "Exercise already exists";
            return;
        }

        db.Exercises.Add(new Exercise
        {
            Name = globalName.Trim(),
            Description = globalDescription,
            IsGlobal = true
        });

        await db.SaveChangesAsync();

        globalName = "";
        globalDescription = "";
        message = "Global exercise created";

        await LoadExercises();
    }

    async Task CreatePersonalExercise()
    {
        if (string.IsNullOrWhiteSpace(personalName))
        {
            message = "Name required";
            return;
        }

        db.Exercises.Add(new Exercise
        {
            Name = personalName.Trim(),
            Description = personalDescription,
            OwnerId = user!.Id,
            IsGlobal = false
        });

        await db.SaveChangesAsync();

        personalName = "";
        personalDescription = "";
        message = "Personal exercise created";

        await LoadExercises();
    }

    async Task DeleteGlobal(int id)
    {
        if (!isAdmin) return;

        var used = await db.WorkoutExercises.AnyAsync(w => w.ExerciseId == id);
        if (used)
        {
            message = "Cannot delete. Used in workouts.";
            return;
        }

        var ex = await db.Exercises.FirstOrDefaultAsync(e => e.Id == id && e.IsGlobal);
        if (ex == null) return;

        db.Exercises.Remove(ex);
        await db.SaveChangesAsync();

        await LoadExercises();
    }

    async Task DeletePersonal(int id)
    {
        var ex = await db.Exercises.FirstOrDefaultAsync(e => e.Id == id && e.OwnerId == user!.Id);
        if (ex == null) return;

        var used = await db.WorkoutExercises.AnyAsync(w => w.ExerciseId == id);
        if (used)
        {
            message = "Cannot delete. Used in workouts.";
            return;
        }

        db.Exercises.Remove(ex);
        await db.SaveChangesAsync();

        await LoadExercises();
    }
}