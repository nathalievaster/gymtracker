@page "/workout/{id:int}"
@attribute [Authorize]
@rendermode InteractiveServer

@using GymTracker.Data
@using GymTracker.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Linq

@inject ApplicationDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager nav

<h2>Workout</h2>

@if (workout == null)
{
    <p>Loading...</p>
}
else
{
    <h3>@workout.Title</h3>
    <p>@workout.Date.ToShortDateString()</p>
    <p>@workout.Notes</p>

    <button class="add-btn" @onclick="OpenExerciseModal">Add exercise</button>

    <h4>Exercises</h4>

    @if (!workout.WorkoutExercises.Any())
    {
        <p>No exercises yet</p>
    }
    else
    {
        @foreach (var we in workout.WorkoutExercises)
        {
            <div style="border:1px solid #ccc; padding:15px; margin-bottom:15px; border-radius:10px;">

                <h5>@we.Exercise?.Name</h5>

                @* LISTA SETS *@
                @if (!we.Sets.Any())
                {
                    <p>No sets yet</p>
                }
                else
                {
                    <ul>
                        @foreach (var s in we.Sets)
                        {
                            <li>@s.Reps reps - @s.Weight kg</li>
                        }
                    </ul>
                }

                @* ADD SET *@
                @if (activeSetExerciseId == we.Id)
                {
                    <div style="margin-top:10px;">
                        <label for="reps">Reps</label>
                        <input name="reps" type="number" @bind="newReps" />

                        <label for="weight">Weight</label>
                        <input name="weight" type="number" @bind="newWeight" />

                        <button class="add-btn" @onclick="() => SaveSet(we.Id)">Save</button>
                        <button class="undo-btn" @onclick="CancelSet">Cancel</button>
                    </div>
                }
                else
                {
                    <button class="add-btn" @onclick="() => StartAddSet(we.Id)">Add set</button>
                }

            </div>
        }
    }

    <br />
    <button class="undo-btn" @onclick="GoBack">Back</button>
}

@if (showExerciseModal)
{
    <div class="modal-backdrop">
        <div class="modal-box">

            <h3>Add exercise</h3>

            <select @bind="selectedExerciseId">
                <option value="0">Select exercise</option>
                @foreach (var ex in allExercises)
                {
                    <option value="@ex.Id">@ex.Name</option>
                }
            </select>

            <br /><br />

            <b>or create new</b>

            <InputText @bind-Value="newExerciseName" placeholder="Exercise name" />

            <br /><br />

            <button class="add-btn" @onclick="AddExerciseToWorkout">Add</button>
            <button class="undo-btn" @onclick="CloseExerciseModal">Cancel</button>

        </div>
    </div>
}

@code {
    List<Exercise> allExercises = new();

    int selectedExerciseId = 0;
    string newExerciseName = "";

    [Parameter] public int id { get; set; }

    WorkoutSession? workout;

    bool showExerciseModal = false;

    // SET STATE
    int activeSetExerciseId = 0;
    int newReps = 0;
    double newWeight = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        workout = db.WorkoutSessions
            .Include(w => w.WorkoutExercises)
            .ThenInclude(we => we.Exercise)
            .Include(w => w.WorkoutExercises)
            .ThenInclude(we => we.Sets)
            .FirstOrDefault(w => w.Id == id && w.UserId == user!.Id);

        if (workout == null)
        {
            nav.NavigateTo("/dashboard");
            return;
        }

        allExercises = db.Exercises.OrderBy(e => e.Name).ToList();
    }

    void GoBack()
    {
        nav.NavigateTo("/dashboard");
    }

    void OpenExerciseModal() => showExerciseModal = true;
    void CloseExerciseModal() => showExerciseModal = false;

    async Task AddExerciseToWorkout()
    {
        Exercise? exercise = null;

        if (selectedExerciseId != 0)
            exercise = db.Exercises.FirstOrDefault(e => e.Id == selectedExerciseId);

        if (!string.IsNullOrWhiteSpace(newExerciseName))
        {
            exercise = new Exercise { Name = newExerciseName };
            db.Exercises.Add(exercise);
            await db.SaveChangesAsync();
        }

        if (exercise == null) return;

        var workoutExercise = new WorkoutExercise
        {
            WorkoutSessionId = workout!.Id,
            ExerciseId = exercise.Id
        };

        db.WorkoutExercises.Add(workoutExercise);
        await db.SaveChangesAsync();

        await ReloadWorkout();

        showExerciseModal = false;
        newExerciseName = "";
        selectedExerciseId = 0;
    }

    void StartAddSet(int workoutExerciseId)
    {
        activeSetExerciseId = workoutExerciseId;
        newReps = 0;
        newWeight = 0;
    }

    void CancelSet()
    {
        activeSetExerciseId = 0;
    }

    async Task SaveSet(int workoutExerciseId)
    {
        if (newReps <= 0) return;

        var set = new SetEntry
        {
            WorkoutExerciseId = workoutExerciseId,
            Reps = newReps,
            Weight = newWeight
        };

        db.Sets.Add(set);
        await db.SaveChangesAsync();

        activeSetExerciseId = 0;
        await ReloadWorkout();
    }

    async Task ReloadWorkout()
    {
        workout = db.WorkoutSessions
            .Include(w => w.WorkoutExercises)
            .ThenInclude(we => we.Exercise)
            .Include(w => w.WorkoutExercises)
            .ThenInclude(we => we.Sets)
            .FirstOrDefault(w => w.Id == workout!.Id);

        await InvokeAsync(StateHasChanged);
    }
}